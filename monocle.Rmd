```{r}
suppressMessages(library(reticulate))
suppressMessages(library(devtools))
suppressMessages(library(monocle))
suppressMessages(library(flexclust))
suppressMessages(library(mcclust))
suppressMessages(library(VGAM))
suppressMessages(library(plotly))

outDir <- getwd()
```

* Load the data
* Normalize and preprocess

```{r}
FGC <- readRDS("/path/to/FGC.rds") 

## Extract raw counts and normalized counts from seurat object for specific clusters
clusters <- c(0, 2, 3, 4)
clBool <- FGC@meta.data$res.0.6 %in% clusters
cellIDs <- FGC@data@Dimnames[[2]][clBool]
l <- (strsplit( cellIDs, split = "_"))
embryoAge <- sapply(l, function(el){el[2]} )
expression <- FGC@data[,cellIDs]
counts <- as.matrix(FGC@raw.data[,cellIDs])
length(cellIDs)

## GroupInfo
groupInfo <- paste0('cluster', FGC@meta.data$res.0.6[clBool])
head(groupInfo)
names(groupInfo)<-colnames(counts)

## Get the gene and cell IDs 
geneIDs <- rownames(counts)
geneIDs.df <- data.frame(geneIDs)
colnames(geneIDs.df) <- "gene_short_name"

## Create the phenoData and featureData Objects
fd <- new("AnnotatedDataFrame", data = geneIDs.df)
cellIDs <- colnames(counts)
phenoData <- data.frame(cellIDs)
rownames(phenoData) <- cellIDs
phenoData$oldClusters <- groupInfo
phenoData$embryoAge <- embryoAge
pd <- new("AnnotatedDataFrame", data = phenoData)
geneIDs.df <- data.frame(geneIDs)
colnames(geneIDs.df) <- "gene_short_name"
rownames(geneIDs.df) <- geneIDs
fd <- new("AnnotatedDataFrame", data = geneIDs.df)

# Create a CellDataSet from the relative expression levels
cds <- newCellDataSet(cellData = counts, 
                      phenoData = pd,
                      featureData = fd,
                      expressionFamily = negbinomial.size() )
```

```{r}
# Pass TRUE if you want to see progress output on some of Monocle 3's operations
DelayedArray:::set_verbose_block_processing(TRUE)

# Passing a higher value will make some computations faster but use more memory. Adjust with caution!
options(DelayedArray.block.size=1000e6)

cds <- estimateSizeFactors(cds)
cds <- estimateDispersions(cds)
```

* Project the data intothe top principal components

```{r}
cds <- preprocessCDS(cds, num_dim = 20, verbose = TRUE)
```

* Step 2: Reduce the dimensionality of the data 

```{r}
cds <- reduceDimension(cds, reduction_method = 'UMAP', n_neighbors = 30)
```

* Step 3: Partition the cells into supergroups 

```{r}
cds <- partitionCells(cds , k = 150)
```

* Step 4: Learn the principal graph 

```{r}
cds <- learnGraph(cds,  RGE_method = 'SimplePPT')
```

* Plot trajectory into the UMAP coordinates

```{r}
plot_cell_trajectory(cds, color_by = "embryoAge", do.return = TRUE)
```

```{r}
plot_cell_trajectory(cds,
                     color_by = "oldClusters")
```

```{r}
plot_cell_trajectory(cds, markers = c("POU5F1", "SPO11", "ZP3", "STRA8"), use_color_gradient = TRUE);
```

```{r}
plot_cell_trajectory(cds, markers = c("NANOS3", "PDPN", "DDX4", "STRA8"), use_color_gradient = TRUE);
```

### Remove cells from weeks 5, 7, 8

```{r}
FGC <- readRDS("/path/to/FGC.rds") 
```

```{r}
## Extract raw counts and normalized counts from seurat object for specific clusters
clusters <- c(0, 2, 3, 4)
clBool <- FGC@meta.data$res.0.6 %in% clusters
FGC_CLustIDs <- FGC@meta.data$res.0.6[clBool]
cellIDs <- FGC@data@Dimnames[[2]][clBool]
clBool <- !grepl("_[5,7,8]W_", cellIDs)
cellIDs <- cellIDs[grep("_[5,7,8]W_", cellIDs, invert = TRUE)]
l <- (strsplit( cellIDs, split = "_"))
embryoAge <- sapply(l, function(el){el[2]} )
expression <- FGC@data[,cellIDs]
counts <- as.matrix(FGC@raw.data[,cellIDs])
length(cellIDs)

## GroupInfo
groupInfo <- paste0('cluster', FGC_CLustIDs[clBool])
head(groupInfo)
names(groupInfo)<-colnames(counts)

## Get the gene and cell IDs 
geneIDs <- rownames(counts)
geneIDs.df <- data.frame(geneIDs)
colnames(geneIDs.df) <- "gene_short_name"

## Create the phenoData and featureData Objects
fd <- new("AnnotatedDataFrame", data = geneIDs.df)
cellIDs <- colnames(counts)
phenoData <- data.frame(cellIDs)
rownames(phenoData) <- cellIDs
phenoData$oldClusters <- groupInfo
phenoData$embryoAge <- embryoAge
pd <- new("AnnotatedDataFrame", data = phenoData)
geneIDs.df <- data.frame(geneIDs)
colnames(geneIDs.df) <- "gene_short_name"
rownames(geneIDs.df) <- geneIDs
fd <- new("AnnotatedDataFrame", data = geneIDs.df)

# Create a CellDataSet from the relative expression levels
cds <- newCellDataSet(cellData = counts, 
                      phenoData = pd,
                      featureData = fd,
                      expressionFamily = negbinomial.size() )
```

```{r}
# Pass TRUE if you want to see progress output on some of Monocle 3's operations
DelayedArray:::set_verbose_block_processing(TRUE)

# Passing a higher value will make some computations faster but use more memory. Adjust with caution!
options(DelayedArray.block.size=1000e6)

cds <- estimateSizeFactors(cds)
cds <- estimateDispersions(cds)
```

* Project the data into the top principal components

```{r}
cds <- preprocessCDS(cds, num_dim = 20, verbose = TRUE)
```

* Step 2: Reduce the dimensionality of the data 

```{r}
cds <- reduceDimension(cds, reduction_method = 'UMAP', n_neighbors = 25)
```

* Step 3: Partition the cells into supergroups 

```{r}
cds <- partitionCells(cds , k = 120)
```

* Step 4: Learn the principal graph 

```{r}
cds <- learnGraph(cds, RGE_method = 'SimplePPT')
```

```{r}
plot_cell_trajectory(cds, color_by = "oldClusters")
```

```{r}
plot_cell_trajectory(cds, color_by = "embryoAge")
ggsave(paste0(outDir, "/trajectoryEmbryoAge.pdf"), width = 7, height = 7)
plot_cell_trajectory(cds, color_by = "embryoAge") +
    facet_wrap(~embryoAge, nrow = 2)
```

```{r}
pdf(file = paste0(outDir, "/oldClustersTrajectoryV1.7.pdf"), version = "1.7")
plot_cell_trajectory(cds, color_by = "oldClusters")
dev.off()

plot_cell_trajectory(cds, color_by = "oldClusters")
ggsave(paste0(outDir, "/oldClustersTrajectory_ggsave.pdf"), width = 7, height = 7)
```

```{r}
plot_cell_trajectory(cds, markers = c("POU5F1", "SPO11", "ZP3", "SYCP1"), use_color_gradient = TRUE);
ggsave(paste0(outDir, "/trajectoryMarkers1.pdf"), width = 7, height = 7)
```

```{r}
plot_cell_trajectory(cds, markers = c("NANOS3", "PDPN", "DDX4", "STRA8"), use_color_gradient = TRUE);
ggsave(paste0(outDir, "/trajectoryMarkers2.pdf"), width = 7, height = 7)
```

```{r}
plot_cell_trajectory(cds, markers = c("PFKP", "OOSP2", "ZP3", "DPPA3"), use_color_gradient = TRUE);
```

### Try DDRTree instead of SimplePTT as a RGE (Reverse Graph embeding) method 

```{r}

## Extract raw counts and normalized counts from seurat object for specific clusters
clusters <- c(0, 2, 3, 4)
clBool <- FGC@meta.data$res.0.6 %in% clusters
FGC_CLustIDs <- FGC@meta.data$res.0.6[clBool]
cellIDs <- FGC@data@Dimnames[[2]][clBool]
clBool <- !grepl("_[5,7,8]W_", cellIDs)
cellIDs <- cellIDs[grep("_[5,7,8]W_", cellIDs, invert = TRUE)]
l <- (strsplit( cellIDs, split = "_"))
embryoAge <- sapply(l, function(el){el[2]} )
expression <- FGC@data[,cellIDs]
counts <- as.matrix(FGC@raw.data[,cellIDs])
length(cellIDs)

## GroupInfo
groupInfo <- paste0('cluster', FGC_CLustIDs[clBool])
head(groupInfo)
names(groupInfo)<-colnames(counts)

## Get the gene and cell IDs 
geneIDs <- rownames(counts)
geneIDs.df <- data.frame(geneIDs)
colnames(geneIDs.df) <- "gene_short_name"

## Create the phenoData and featureData Objects
fd <- new("AnnotatedDataFrame", data = geneIDs.df)
cellIDs <- colnames(counts)
phenoData <- data.frame(cellIDs)
rownames(phenoData) <- cellIDs
phenoData$oldClusters <- groupInfo
phenoData$embryoAge <- embryoAge
pd <- new("AnnotatedDataFrame", data = phenoData)
geneIDs.df <- data.frame(geneIDs)
colnames(geneIDs.df) <- "gene_short_name"
rownames(geneIDs.df) <- geneIDs
fd <- new("AnnotatedDataFrame", data = geneIDs.df)

# Create a CellDataSet from the relative expression levels
cds <- newCellDataSet(cellData = counts, 
                      phenoData = pd,
                      featureData = fd,
                      expressionFamily = negbinomial.size() )
```

```{r}
# Pass TRUE if you want to see progress output on some of Monocle 3's operations
DelayedArray:::set_verbose_block_processing(TRUE)

# Passing a higher value will make some computations faster but use more memory. Adjust with caution!
options(DelayedArray.block.size=1000e6)

cds <- estimateSizeFactors(cds)
cds <- estimateDispersions(cds)
```

* Project the data into the top principal components

```{r}
cds <- preprocessCDS(cds, num_dim = 20, verbose = TRUE)
```

* Step 2: Reduce the dimensionality of the data 

```{r}
cds <- reduceDimension(cds, reduction_method = 'UMAP', n_neighbors = 25)
```

* Step 3: Partition the cells into supergroups 

```{r}
cds <- partitionCells(cds , k = 120)
```

* Step 4: Learn the principal graph 

```{r}
#cds <- learnGraph(cds, RGE_method = 'SimplePPT')
```

```{r}
cds <- learnGraph(cds,  RGE_method = 'DDRTree')
```

```{r}
plot_cell_trajectory(cds, color_by = "embryoAge")
plot_cell_trajectory(cds, color_by = "embryoAge") +
    facet_wrap(~embryoAge, nrow = 2)
```

```{r}
plot_cell_trajectory(cds, color_by = "oldClusters")
```

```{r}
plot_cell_trajectory(cds, markers = c("POU5F1", "SPO11", "ZP3", "SYCP1"), use_color_gradient = TRUE);
```

```{r}
plot_cell_trajectory(cds, markers = c("NANOS3", "PDPN", "DDX4", "STRA8"), use_color_gradient = TRUE);
```

```{r}
plot_cell_trajectory(cds, markers = c("PFKP", "OOSP2", "ZP3", "DPPA3"), use_color_gradient = TRUE);
```

```{r}
```
